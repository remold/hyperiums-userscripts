// ==UserScript==
// @name        Exploitations Avg
// @namespace   http://github.com/remold/hyperiums-greasemonkey/
// @require     http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js
// @include     http://hyp2.hyperiums.com/servlet/Trading
// @version     2
// @grant       none
// @copyright   2014+, Remold Krol (https://github.com/remold)
// @license     Apache License, Version 2.0 (http://www.apache.org/licenses/LICENSE-2.0)
// @author      Remold Krol
// @homepage    https://github.com/remold
// ==/UserScript==

/* global $:false */

"use strict";

function addGlobalStyle(css) {
    var head, style;
    head = document.getElementsByTagName('head')[0];
    if (!head) {
        return;
    }
    style = document.createElement('style');
    style.type = 'text/css';
    style.innerHTML = css;
    head.appendChild(style);
}

function extractGrowth(sStr) {
    var rx = /Organic growth: (.*) \//g;
    var arr = rx.exec(sStr);
    return arr[1];
}

addGlobalStyle(".td_right { text-align: right ! important; } .th_right { text-align: right ! important; }");

var tmpExploits = 0;
var exploits = {
        sum: 0,
        max: 0,
        min: 9999999,
        avg: 0,
        planets: 0

};

$('body form tr:not(#stdArray) tbody tr').has('tbody').filter(':odd')
    .each(function (idx, elt) {
        tmpExploits = parseInt( $(elt).find('td:last()').text());
        exploits.planets++;
        exploits.sum += tmpExploits;
        if (tmpExploits > exploits.max) {
            exploits.max = tmpExploits;
        }
        if (tmpExploits < exploits.min) {
            exploits.min = tmpExploits;
        }
    }
);


if (exploits.sum > 0) {
    exploits.avg = Math.round(exploits.sum / exploits.planets);
}


if (exploits.sum == 0) {
    exploits.sum = " ."
}
if (exploits.max == 0) {
    exploits.max = " ."
}
if (exploits.avg == 0) {
    exploits.avg = " ."
}
if (exploits.min == 9999999) {
    exploits.min = " ."
}

$('body div.tinytext:last')
    .after(
        '<div class="banner" ' +
            'style="text-align: left; width: 580px;" ' +
            '>' +
            '<table border="0" width="100%">' +
            '<tr><th></th>' +
            '<th class="th_right"> Exploits</th>' +
            '</tr>' +

            '<tr><td>Planet #</td>' +
            '<td class="td_right"> ' + exploits.planets + '</td></tr>' +

            '<tr><td>Population Sum</td>' +
            '<td class="td_right"> ' + exploits.sum + '</td></tr>' +

            '<tr><td>Population Max</td>' +
            '<td class="td_right"> ' + exploits.max + '</td></tr>' +

            '<tr><td>Population Avg</td>' +
            '<td class="td_right"> ' + exploits.avg + '</td></tr>' +

            '<tr><td>Population Min</td>' +
            '<td class="td_right"> ' + exploits.min + '</td></tr>' +

            '</table></div><br />'
    );

